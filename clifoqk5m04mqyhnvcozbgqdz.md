---
title: "æ“´å…… ChatGPTï¼ŒæŸ¥è³‡æ–™ä¸å¿…å†å—å›°æ–¼åˆ†é å¢æ—ä¸­"
datePublished: Tue Feb 21 2023 11:53:45 GMT+0000 (Coordinated Universal Time)
cuid: clifoqk5m04mqyhnvcozbgqdz
slug: e693b4e58585-chatgpt-e69fa5e8b387e69699e4b88de5bf85e5868de58f97e59bb0e696bce58886e9a081e58fa2e69e97e4b8ad-9beaa3b68d18
cover: https://cdn.hashnode.com/res/hashnode/image/upload/v1685778068299/87c39f26-d11e-470f-8983-caf20a7d4f63.png

---

#### google chrome æ’ä»¶åˆ†äº«èˆ‡å‰ç«¯æŠ€è¡“äº¤æµ

> Highlight unknown sentence, and letâ€™s ChatGPT explain toÂ you

å¹´å¾Œæ”¶å‡å‰ç­†è€…å¯«äº†ä¸€å€‹è¼”åŠ©ä½¿ç”¨ ChatGPT çš„ chrome extension  
ç—›é»ä¾†è‡ªæ–¼ç­†è€…åœ¨æŸ¥ç¶²é è³‡æ–™æ™‚ï¼Œå¦‚æœæœ‰é‡åˆ°ä¸æ‡‚çš„è©æˆ–æ®µè½ï¼Œå°±éœ€è¦é¡å¤–åˆ‡åˆ†é å…ˆæŸ¥ï¼ŒæŸ¥å®Œå†è·³å›ä¾†å¾ˆå®¹æ˜“å¿˜è¨˜åŸæœ¬åœ¨å¹¹å˜›ï¼ˆæ—¥å¸¸åˆ†é å¤ªå¤šç›´æ¥ä¸€å€‹å¤§è…¦éœ§ï¼‰

å› æ­¤ç­†è€…ç§‰æŒè‘—å·¥ç¨‹å¸«å¤©ç”Ÿå°±æ˜¯æ‡¶ï¼ˆxï¼Œè¿½æ±‚é«˜åº¦è‡ªå‹•åŒ–ï¼ˆo çš„ç‰¹è³ªï¼Œå†æ€è€ƒæœ‰ä»€éº¼è§£æ³•å¯ä»¥è®“ä½¿ç”¨ ChatGPT æŸ¥è©¢æ™‚æ›´æ–¹ä¾¿ï¼Œä¸²æ¥é€™ç¨® API æœå‹™çš„ä»‹é¢æœ‰å¹¾ç¨®å¸¸è¦‹çš„è¡¨ç¾å½¢å¼ï¼š

*   èŠå¤©æ©Ÿå™¨äººï¼ˆæ¯”å¦‚line botã€discordï¼‰
*   ç¶²é 
*   æ¡Œé¢æ‡‰ç”¨ç¨‹å¼
*   ç€è¦½å™¨æ“´å……å¥—ä»¶

ç”±æ–¼ç­†è€…è¨­å®šçš„æƒ…å¢ƒä¸»è¦æ˜¯å¸Œæœ›è¼”åŠ©ä½¿ç”¨è€…åœ¨æŸ¥ç¶²è·¯æ–‡ç« å­¸ç¿’æ™‚ï¼Œå¦‚æœé‡åˆ°ä¸æ‡‚çš„é—œéµå­—å¯ä»¥æ›´å¿«çš„äº†è§£å¤§æ¦‚æ„æ€ï¼Œè€Œä¸ä¸­æ–·åŸæœ¬æ­£åœ¨å­¸ç¿’çš„ä¸»é¡Œï¼Œå‰ä¸‰è€…éƒ½éœ€è¦ä¸€å€‹æ–°çš„ä»‹é¢æˆ–åˆ†é ä¾†é¡¯ç¤ºè³‡è¨Šï¼›è€Œç€è¦½å™¨æ“´å……å¥—ä»¶å¯ä»¥ç›´æ¥æ“ä½œç•¶å‰ç¶²é çš„DOMï¼Œç§€å‡ºä¸€å€‹è‡ªè¨‚çš„popupè¦–çª—ç”¨ä¾†é¡¯ç¤ºè³‡è¨Šï¼Œå› æ­¤ç­†è€…è¦ºå¾—é€™æ¨£çš„æ–¹å¼å¯ä»¥ä¸ç”¨åˆ‡æ›åˆ†é ä¾†é¡¯ç¤ºæŸ¥è©¢çµæœï¼Œå°ä½¿ç”¨è€…æ˜¯æœ€ç‚ºæ–¹ä¾¿çš„

é¸å®šåŸ·è¡Œæ–¹å‘å¾Œï¼Œç­†è€…æ¨¡ä»¿äº†google translation extensionçš„åšæ³•ï¼Œåµæ¸¬åç™½çš„å­—è©ï¼Œåç™½çµæŸå¾Œè·³å‡ºä¸€å€‹å° iconï¼Œé»ä¸‹å»æœƒå‡ºç¾ä¸€å€‹ popup é¡¯ç¤ºChatGPT å°åç™½æ–‡å­—çš„è§£é‡‹

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1685778057986/63ef7c86-9675-4285-bde4-475325df0dea.png)

å¦‚æœåªæ˜¯è¦æŸ¥è©¢å–®è©ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‰å³éµï¼Œé¸å–context menué¸å–®ä¸­çš„é¸é …

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1685778061232/464484ae-51ce-4125-82fa-0059e42e05f2.png)

demoå½±ç‰‡å¯è¦‹æ­¤ï¼š

<iframe src="https://www.youtube.com/embed/5MAh_BZvF6Q?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe>

ç›®å‰å·²ä¸Šæ¶åœ¨ google chrome extension å•†åº—ï¼Œå’Œç­†è€…ä¸€æ¨£è¦ºå¾—å­¸ç¿’éç¨‹ä¸­æœ‰ä¸€æ¨£ç—›é»çš„äººå¯ä»¥ä¸‹è¼‰ç©çœ‹çœ‹ï¼æœ‰å…¶ä»–æƒ³è¦çš„feature / ç™¼ç¾çš„bugä¹Ÿå¯ä»¥ç›´æ¥åœ¨ google chrome extension å•†åº—ç•™è¨€ or gitlab repo ä¸Šç™¼ issue

chrome extension ä¸‹è¼‰é€£çµï¼š

[**Hey ChatGPT Explain This**  
*Highlight unknown sentence, and let's ChatGPT explain to you*chrome.google.com](https://chrome.google.com/webstore/detail/hey-chatgpt-explain-this/ncockfahljbgijljglbmmagefbdheofd "https://chrome.google.com/webstore/detail/hey-chatgpt-explain-this/ncockfahljbgijljglbmmagefbdheofd")[](https://chrome.google.com/webstore/detail/hey-chatgpt-explain-this/ncockfahljbgijljglbmmagefbdheofd)

gitlab repoï¼š

[**warren30815 / hey-chatgpt-explain-this Â· GitLab**  
*GitLab.com*gitlab.com](https://gitlab.com/warren30815/hey_chatgpt_explain_this "https://gitlab.com/warren30815/hey_chatgpt_explain_this")[](https://gitlab.com/warren30815/hey_chatgpt_explain_this)

â€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šä¸‹æ–¹ç‚ºå¦‚ä½•æ’°å¯«è©²æ’ä»¶çš„å‰ç«¯æŠ€è¡“åˆ†äº«â€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šâ€”â€Šâ€” â€”

é€™éƒ¨åˆ†ä¸»è¦æ˜¯ for å‰ç«¯å·¥ç¨‹å¸«çœ‹çš„

#### **å°ˆæ¡ˆåŸºæœ¬çµæ§‹ï¼š**

ç°¡å–®ä¾†èªªå¯« chrome extension è·Ÿå¯«ç¶²é å·®ä¸å¤š  
ä¸»è¦åˆ†æˆèƒ½è·Ÿ DOM äº’å‹•çš„ content scriptï¼ˆforegroundï¼Œmain threadï¼‰  
èˆ‡åœ¨ chrome èƒŒæ™¯åŸ·è¡Œçš„ service workerï¼ˆbackgroundï¼Œworker threadï¼Œä¸å¯æ“ä½œ DOM ä¹Ÿä¸èƒ½å–ç”¨ windowï¼‰

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1685778063129/e038a8e7-00c9-4cc5-890d-c7b5fb342b7c.png)

credit: [https://hackmd.io/@lala-lee-jobs/service-worker](https://hackmd.io/@lala-lee-jobs/service-worker)

content script æˆ‘ä¸»è¦æ‹¿ä¾†æ§åˆ¶ popup çš„é¡¯ç¤ºã€æ›´æ–°æ¸²æŸ“å…§å®¹ã€æ»‘é¼ äº‹ä»¶è™•ç†  
service worker æˆ‘ä¸»è¦æ‹¿ä¾† call API å’Œ streaming çµæœçµ¦ content script

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1685778065327/9197b650-67b2-400c-a57e-41fc02d3d2a4.jpeg)

credit: [https://slideplayer.com/slide/15938823/](https://slideplayer.com/slide/15938823/)

Githubä¸Šä¹Ÿæœ‰è¨±å¤š starter project å¯ä»¥ç›´æ¥ä½œç‚º scaffold

[**Build software better, together**  
*GitHub's search supports a variety of different operations. Here's a quick cheat sheet for some of the common searchesâ€¦*github.com](https://github.com/search?q=chrome+extension+starter "https://github.com/search?q=chrome+extension+starter")[](https://github.com/search?q=chrome+extension+starter)

#### å¯¦ä½œä¸Šçš„å¹¾å€‹é‡é»ï¼š

é¦–å…ˆæˆ‘å€‘å…ˆ recap ä¸€ä¸‹æ•´é«”çš„ä½¿ç”¨æµç¨‹ï¼š

1.  Install the extension, and you will see a popup window.
2.  Visit [OpenAI website](https://beta.openai.com/account/api-keys) to get API key.
3.  Register your OpenAI API KEY to the input field.
4.  Once finished, you can highlight some sentence in any website. You will find a icon button when you release your mouse and click it.
5.  The highlighted sentence will be sent to ChatGPT, and it will explain the sentence meaning for you.

*   ç‚ºæ±‚å¿«é€Ÿé–‹ç™¼ï¼Œç­†è€…é€™é‚Šå°±æ²’æœ‰å»ä¸²æ¥ openai ç™»å…¥é©—è­‰æµç¨‹æ‹¿ access tokenï¼ˆkey for shortï¼‰ï¼Œè€Œæ˜¯è«‹ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥ keyï¼Œé€™é‚Šæƒ³æ¢è¨çš„ä¸»è¦æ˜¯æ‹¿åˆ° key å¾Œè¦å¦‚ä½•ä¿å­˜æ–¼ç€è¦½å™¨ï¼Œchrome extension é€™é‚Šæœ‰æä¾›å°ˆé–€ for extension ç‰ˆæœ¬çš„ storageï¼Œç­†è€…é€™é‚Šä½¿ç”¨ chrome.storage.sessionï¼Œå…¶å°‡è³‡æ–™å­˜æ–¼ memoryï¼Œç€è¦½å™¨é—œé–‰æ™‚æœƒè‡ªå‹•æ¸…é™¤ï¼Œå®‰å…¨æ€§è¼ƒä½³ï¼Œç•¶ç„¶é‚„æ˜¯æœ‰å¯èƒ½è¢«å…¶ä»–æƒ¡æ„çš„ chrome extension or script running in the same origin çµ¦ dump å‡ºä¾†ï¼Œå› æ­¤å¯ä»¥å†åŠ å…¥æ™‚é–“éæœŸè‡ªå‹•æ¸…é™¤æ©Ÿåˆ¶ï¼Œåªæ˜¯ä½¿ç”¨è€…å°±æœƒéœ€è¦æ™‚ä¸æ™‚å†æˆæ¬Šä¸€æ¬¡ï¼Œé€™å€‹éæœŸæ™‚é–“æ˜¯ä¸€å€‹è³‡å®‰èˆ‡ UX çš„ tradeoff

[**chrome.storageâ€Šâ€”â€ŠChrome Developers**  
*The Storage API provides an extension-specific way to persist user data and state. Itâ€™s similar to the web platformâ€™sâ€¦*developer.chrome.com](https://developer.chrome.com/docs/extensions/reference/storage/#property-session "https://developer.chrome.com/docs/extensions/reference/storage/#property-session")[](https://developer.chrome.com/docs/extensions/reference/storage/#property-session)

*   åµæ¸¬åç™½çµæŸçš„äº‹ä»¶ï¼Œç”±æ–¼ Web API æ²’æœ‰æä¾› selection end çš„äº‹ä»¶ï¼Œåªæœ‰ selectionchangeï¼Œå› æ­¤é€éçµåˆ mouseup äº‹ä»¶ï¼Œå¯¦ä½œä¸€å€‹å¸¶æœ‰ debounce æ©Ÿåˆ¶çš„ selectionend äº‹ä»¶

// debounce version of selection event  
  
let selectionEndTimeout: NodeJS.Timeout = null  
  
document.addEventListener('mouseup', (evt: MouseEvent) => {  
    selectionEndTimeout = setTimeout(() => {  
        const haveText = window.getSelection().toString() !== ''  
        if (haveText) {  
            // handle select end event (show icon button)  
        }  
    }, 100)  
})  
document.addEventListener('selectionchange', () => {  
    if (selectionEndTimeout) {  
        clearTimeout(selectionEndTimeout)  
    }  
})

*   è¨ˆç®—ç”¨ä¾†é¡¯ç¤º query çµæœçš„ popup ä½ç½®ï¼ˆgetBoundingClientRectï¼Œæ”¾ç½®æ–¼é¸å–æ–‡å­—å€åŸŸçš„ä¸‹æ–¹ï¼Œéœ€è€ƒæ…®æœ‰ scrolling æ™‚çš„æƒ…æ³ï¼‰

const getPosition = (el: Range) => {  
    const rect = el.getBoundingClientRect()  
    return {  
        left: rect.left + window.pageXOffset, // pageXOffset: consider scrolling  
        top: rect.top + window.pageYOffset, // pageYOffset: consider scrolling  
        width: rect.width,  
        height: rect.height,  
    }  
}  
  
const { left, top, height } = getPosition(  
    document.getSelection().getRangeAt(0), // é¸å–ç¯„åœå€å¡Š  
)  
popup = document.createElement('div')  
popup.style.position = 'absolute'  
popup.style.left = \`${left}px\`  
popup.style.top = \`${top + height}px\`

*   Query ChatGPT API and response with streaming modeï¼ˆHTTP POST method + stream: trueï¼‰

const resp = await fetch('https://api.openai.com/v1/completions', {  
    method: 'POST',  
    headers: {  
        'Content-Type': 'application/json',  
        Authorization: \`Bearer ${API\_KEY}\`,  
    },  
    body: JSON.stringify({  
        model: 'text-davinci-003',  
        prompt: \`Explain this: ${queryText}\`,  
        temperature: 0.5,  
        max\_tokens: 1000,  
        stream: true, // get response with streaming mode  
    }),  
})

*   Handle streaming API response (ä½¿ç”¨ eventsource-parser å¥—ä»¶ä¾†å¹«åŠ©è§£æ streaming dataï¼‰

import { createParser } from â€˜eventsource-parserâ€™  
  
const readStream = (reader: ReadableStreamDefaultReader, callback: Function) => {  
    reader.read().then(({ done, value }: any) => {  
        if (done) {  
            reader.releaseLock()  
            return null  
        }  
        callback(value)  
        return readStream(reader, callback)  
    })  
}  
const streamAsyncIterable = (stream: ReadableStream, callback: Function) => {  
    const reader = stream.getReader()  
    readStream(reader, callback)  
}  
  
const parser = createParser(event => {  
    if (event.type === â€˜eventâ€™) {  
        const message = event.data  
        if (message === â€˜\[DONE\]â€™) { // chatgpt api streaming çµæŸæ™‚çš„ EOF  
            return  
        }  
        let data  
        try {  
            data = JSON.parse(message)  
            const { text } = data.choices\[0\]  
            if (text === â€˜<|im\_end|>â€™ || text === â€˜<|im\_sep|>â€™) {  
                return  
            }  
            // text is the streaming API response chunk  
        } catch (err) {  
        }  
    }  
})  
  
// resp ç‚ºä¸Šé¢çš„ await fetch å¾Œå›å‚³çš„ Response ç‰©ä»¶  
streamAsyncIterable(resp.body!, (value: BufferSource) => {  
    const str = new TextDecoder().decode(value)  
    parser.feed(str)  
})

*   content script èˆ‡ service worker çš„æºé€šï¼ˆchrome.runtime.Port.postMessage ç”¨ä¾†é¿å…å› ç‚ºåˆ‡æ›åˆ†é é€ æˆæ¥æ”¶ API response çš„é€šé“æ–·ç·š + chrome.tabs.sendMessage ç”¨ä¾†è™•ç†å³éµé¸å–®çš„æºé€šï¼‰
*   å›  popup æ¡ç”¨ singleton è¨­è¨ˆæ¨¡å¼ï¼Œæœƒæœ‰å¤šå€‹ request çš„ response è³‡æ–™é‡ç–Šå•é¡Œï¼Œå› æ­¤ç­†è€…å°‡å…¶ç•¶ä½œ MQTT çš„æ–¹å¼ä¾†è™•ç†ï¼Œé–‹ request æ™‚å°‡å‚³è¼¸ port name åŠ ä¸Š uuidï¼Œæ”¶åˆ°æ¯å€‹ API streaming response chunk æ™‚ï¼Œå‚³çµ¦ content script ä¹Ÿæœƒé™„ä¸Šå…¶æ‰€å±¬çš„ port nameï¼Œç”¨ä»¥ç•¶æˆè­˜åˆ¥ idï¼Œé¿å…ä¸åŒé€šé“çš„è¨Šæ¯äº’ç›¸å¹²æ“¾

// in background:   
  
// postMessage: (property) chrome.runtime.Port.postMessage: (message: any) => void  
// postMessageï¼ˆç™¼é€è¨Šæ¯ï¼‰  
port.postMessage({  
    action: 'ans',  
    portName: port.name,  
    result: mes,  
})  
  
// in foreground:  
// onmessageï¼ˆæ¥æ”¶è¨Šæ¯ï¼‰  
  
port.onMessage.addListener(async (message: any) => {  
    if (message.action === 'ans' && message.portName === currentPortName) {  
        // å°‡ message.result çš„å…§å®¹ update to popup  
    }  
})

And thatâ€™s a wrap! Enjoy. ğŸ†

ğŸ‘

My Linkedin: [https://www.linkedin.com/in/%E7%AB%A3%E7%BF%94-%E8%A8%B1-3188a41a1/](https://www.linkedin.com/in/%E7%AB%A3%E7%BF%94-%E8%A8%B1-3188a41a1/)